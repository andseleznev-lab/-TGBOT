# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: Supabase PostgreSQL + Realtime WebSocket

**–¢–∏–∫–µ—Ç**: T-006
**PRD**: `docs/prd/T-006.prd.md`
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2026-02-15
**–°—Ç–∞—Ç—É—Å**: IN PROGRESS

---

## üéØ –¶–µ–ª—å

–ó–∞–º–µ–Ω–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É `club.json` (polling) –Ω–∞ **Supabase PostgreSQL + Realtime WebSocket** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ (<1 —Å–µ–∫) –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞.

**–ü—Ä–æ–±–ª–µ–º–∞ T-005**: GitHub Pages CDN –∫–µ—à–∏—Ä—É–µ—Ç club.json –Ω–∞ 4-5 –º–∏–Ω—É—Ç ‚Üí –ø–ª–æ—Ö–æ–π UX.

**–†–µ—à–µ–Ω–∏–µ T-006**: Supabase Realtime ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è < 1 —Å–µ–∫—É–Ω–¥—ã ‚Üí –æ—Ç–ª–∏—á–Ω—ã–π UX!

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         –ê–†–•–ò–¢–ï–ö–¢–£–†–ê T-006                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ (Telegram Mini App)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ù–∞–∂–∏–º–∞–µ—Ç "–ö—É–ø–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç 2990‚ÇΩ"
   ‚îÇ   ‚îî‚îÄ‚ñ∫ app.js ‚Üí createClubPayment()
   ‚îÇ       ‚îî‚îÄ‚ñ∫ YooKassa Checkout (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime (–ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—É–±")
   ‚îÇ   ‚îî‚îÄ‚ñ∫ app.js ‚Üí supabase.channel('club-payments')
   ‚îÇ       ‚îî‚îÄ‚ñ∫ WebSocket: wss://ujldixoiaqybtnifzhgy.supabase.co/realtime/v1
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ü–æ–ª—É—á–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞—Ç–µ–∂–µ
       ‚îî‚îÄ‚ñ∫ Realtime —Å–æ–±—ã—Ç–∏–µ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (< 1 —Å–µ–∫)

2. YOOKASSA (–ü–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑)
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
       ‚îî‚îÄ‚ñ∫ Webhook POST ‚Üí Make.com
           ‚îî‚îÄ‚ñ∫ Payload: { payment_id, telegram_user_id, amount, status }

3. MAKE.COM (Backend –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ü–æ–ª—É—á–∞–µ—Ç webhook –æ—Ç YooKassa
   ‚îÇ   ‚îî‚îÄ‚ñ∫ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (payment_id, amount = 299000)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ INSERT –≤ Supabase PostgreSQL
   ‚îÇ   ‚îî‚îÄ‚ñ∫ REST API POST https://ujldixoiaqybtnifzhgy.supabase.co/rest/v1/club_payments
   ‚îÇ       Headers: Authorization: Bearer {service_role_key}
   ‚îÇ       Body: { payment_id, telegram_user_id, amount, status: "succeeded" }
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Make.com History

4. SUPABASE (PostgreSQL + Realtime)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ PostgreSQL Database
   ‚îÇ   ‚îî‚îÄ‚ñ∫ –¢–∞–±–ª–∏—Ü–∞: club_payments
   ‚îÇ       ‚îú‚îÄ‚ñ∫ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (READ = anon, WRITE = service_role)
   ‚îÇ       ‚îú‚îÄ‚ñ∫ Constraints (unique payment_id, valid status)
   ‚îÇ       ‚îî‚îÄ‚ñ∫ Indexes (telegram_user_id, status, created_at)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ Realtime Server
   ‚îÇ   ‚îî‚îÄ‚ñ∫ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ WebSocket
   ‚îÇ       ‚îî‚îÄ‚ñ∫ Event: INSERT ‚Üí broadcast –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ REST API
       ‚îî‚îÄ‚ñ∫ GET /club_payments?telegram_user_id=eq.{userId}&status=eq.succeeded
           ‚îî‚îÄ‚ñ∫ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

5. –§–†–û–ù–¢–ï–ù–î (app.js)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase Client
   ‚îÇ   ‚îî‚îÄ‚ñ∫ createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—É–±"
   ‚îÇ   ‚îî‚îÄ‚ñ∫ loadClubData() ‚Üí SELECT –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚îÇ
   ‚îú‚îÄ‚ñ∫ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime
   ‚îÇ   ‚îî‚îÄ‚ñ∫ supabase.channel('club-payments')
   ‚îÇ       .on('postgres_changes', { event: 'INSERT', table: 'club_payments' })
   ‚îÇ       .subscribe()
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø–ª–∞—Ç–µ–∂–∞
       ‚îî‚îÄ‚ñ∫ onPaymentReceived(payload)
           ‚îú‚îÄ‚ñ∫ –ü—Ä–æ–≤–µ—Ä–∫–∞: payload.telegram_user_id === userId
           ‚îú‚îÄ‚ñ∫ HapticFeedback.notificationOccurred('success')
           ‚îú‚îÄ‚ñ∫ showSuccessPopup("‚úÖ –ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!")
           ‚îî‚îÄ‚ñ∫ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–ø–æ–∫–∞–∑–∞—Ç—å Zoom —Å—Å—ã–ª–∫—É)
```

---

## üì¶ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –†–æ–ª—å |
|-----------|------------|--------|------|
| Database | PostgreSQL (Supabase) | 15.x | –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–ª–∞—Ç–µ–∂–µ–π |
| Realtime | Supabase Realtime | 2.x | WebSocket pub/sub |
| Frontend SDK | @supabase/supabase-js | 2.39.3 (CDN) | –ö–ª–∏–µ–Ω—Ç –¥–ª—è REST + Realtime |
| Backend | Make.com | - | Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| Payment | YooKassa API | 3.0 | –ü–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑ |
| UI | Telegram Mini App SDK | 7.0+ | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å |

---

## üîß –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Supabase SDK (index.html)

**–§–∞–π–ª**: `index.html`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```html
<!-- –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ config.js -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

<!-- –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
<script src="config.js?v=28"></script> <!-- –±—ã–ª–æ v=27 -->
<script src="app.js?v=43"></script>     <!-- –±—ã–ª–æ v=42 -->
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
- Supabase SDK –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ CDN (–Ω–µ—Ç npm, –ø—Ä–æ–µ–∫—Ç —Å—Ç–∞—Ç–∏—á–Ω—ã–π)
- –†–∞–∑–º–µ—Ä: ~50KB gzipped (–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è Telegram Mini App)
- Global: `window.supabase` –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

---

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase (config.js)

**–§–∞–π–ª**: `config.js`

**–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã**:
```javascript
// Supabase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (T-006)
SUPABASE_URL: 'https://ujldixoiaqybtnifzhgy.supabase.co',
SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqbGRpeG9pYXF5YnRuaWZ6aGd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTkyMDgsImV4cCI6MjA4NTQzNTIwOH0.rHbW1w3XZdcW1XcjQXz3jfFrWA0SzR6K851MAxMSV_E',

// –§–ª–∞–≥ –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞)
USE_SUPABASE: true, // true = Supabase, false = club.json (fallback)
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
- ‚úÖ `SUPABASE_ANON_KEY` - –ø—É–±–ª–∏—á–Ω—ã–π, –º–æ–∂–Ω–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
- ‚ùå `service_role` –∫–ª—é—á - –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ config.js!

---

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase Client (app.js)

**–§–∞–π–ª**: `app.js`

**–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞** (–ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤, –ø–µ—Ä–µ–¥ state):
```javascript
/**
 * Supabase –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL + Realtime
 * @type {Object|null}
 */
let supabaseClient = null;

/**
 * Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–ª–∞—Ç–µ–∂–∏ –∫–ª—É–±–∞
 * @type {Object|null}
 */
let realtimeSubscription = null;

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Supabase –∫–ª–∏–µ–Ω—Ç
 * @returns {Object} Supabase client
 */
function initSupabase() {
  if (!CONFIG.USE_SUPABASE) {
    console.log('‚ö†Ô∏è Supabase –æ—Ç–∫–ª—é—á–µ–Ω (USE_SUPABASE=false), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è club.json');
    return null;
  }

  if (!window.supabase) {
    console.error('‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å index.html');
    return null;
  }

  if (supabaseClient) {
    console.log('‚úÖ Supabase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    return supabaseClient;
  }

  try {
    supabaseClient = window.supabase.createClient(
      CONFIG.SUPABASE_URL,
      CONFIG.SUPABASE_ANON_KEY
    );

    console.log('üîí [Security] Supabase connected', {
      url: CONFIG.SUPABASE_URL,
      keyType: 'anon',
      timestamp: new Date().toISOString()
    });

    return supabaseClient;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
    tg.showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    return null;
  }
}
```

**–í—ã–∑–æ–≤**:
- –í `initApp()` –¥–æ–±–∞–≤–∏—Ç—å: `initSupabase();`

---

### 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (app.js)

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è**:
```javascript
/**
 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
 * @param {number} userId - Telegram User ID
 * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ –ø–ª–∞—Ç–µ–∂–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'succeeded'
 */
async function loadUserPayments(userId) {
  const client = initSupabase();
  if (!client) {
    console.warn('‚ö†Ô∏è Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞');
    return [];
  }

  try {
    console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}...`);

    const { data, error } = await client
      .from('club_payments')
      .select('*')
      .eq('telegram_user_id', userId)
      .eq('status', 'succeeded')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:', error);
      throw error;
    }

    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–ª–∞—Ç–µ–∂–µ–π: ${data.length}`, data);
    return data;
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ loadUserPayments:', error);
    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞');
    return [];
  }
}
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:
- –ó–∞–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ `club.json` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `loadClubData()`
- –í—ã–∑—ã–≤–∞—Ç—å `loadUserPayments(userId)` –≤–º–µ—Å—Ç–æ `fetch(clubJsonUrl)`

---

### 5. Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (app.js)

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è**:
```javascript
/**
 * –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ Realtime —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
 * @param {number} userId - Telegram User ID –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π
 */
function subscribeToPayments(userId) {
  const client = initSupabase();
  if (!client) {
    console.warn('‚ö†Ô∏è Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, Realtime –æ—Ç–∫–ª—é—á—ë–Ω');
    return;
  }

  // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if (realtimeSubscription) {
    console.log('üîå –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ Realtime –∫–∞–Ω–∞–ª–∞');
    realtimeSubscription.unsubscribe();
    realtimeSubscription = null;
  }

  try {
    console.log(`üîå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}...`);

    realtimeSubscription = client
      .channel('club-payments')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'club_payments'
        },
        (payload) => {
          console.log('üîí [Audit] New payment received', {
            payment_id: payload.new.payment_id,
            user_id: payload.new.telegram_user_id,
            amount: payload.new.amount,
            status: payload.new.status,
            timestamp: new Date().toISOString()
          });

          handleRealtimePayment(payload.new, userId);
        }
      )
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('‚úÖ Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞');
        } else if (status === 'CHANNEL_ERROR') {
          console.error('‚ùå –û—à–∏–±–∫–∞ Realtime –∫–∞–Ω–∞–ª–∞:', status);
        }
      });

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Realtime:', error);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Realtime —Å–æ–±—ã—Ç–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
 * @param {Object} payment - –î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ Supabase
 * @param {number} userId - Telegram User ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function handleRealtimePayment(payment, userId) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–ª–∞—Ç—ë–∂ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  if (payment.telegram_user_id !== userId) {
    console.log(`‚è≠Ô∏è –ü–ª–∞—Ç—ë–∂ –Ω–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (${payment.telegram_user_id} !== ${userId})`);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
  if (payment.status !== 'succeeded') {
    console.log(`‚è≠Ô∏è –ü–ª–∞—Ç—ë–∂ –Ω–µ succeeded (status: ${payment.status})`);
    return;
  }

  console.log('üéâ –ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');

  // Haptic feedback (–≤–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞)
  tg.HapticFeedback.notificationOccurred('success');

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup
  showSuccessPopup('‚úÖ –ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!');

  // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—É–±"
  updateClubUIAfterPayment(payment);
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç UI –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—É–±" –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
 * @param {Object} payment - –î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
 */
function updateClubUIAfterPayment(payment) {
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (state.clubData) {
    if (!state.clubData.payments) {
      state.clubData.payments = [];
    }
    state.clubData.payments.push(payment);
  }

  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ö–ª—É–±" (–µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞)
  if (state.currentTab === 'club') {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—É–±"');
    renderClubTab();
  }
}
```

**–í—ã–∑–æ–≤**:
- –í `showTab('club')` –¥–æ–±–∞–≤–∏—Ç—å: `subscribeToPayments(userId);`
- –í `showTab(otherTab)` –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø–∏—Å–∫—É: `if (realtimeSubscription) realtimeSubscription.unsubscribe();`

---

### 6. Cleanup –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–î–æ–±–∞–≤–∏—Ç—å –≤ app.js**:
```javascript
/**
 * –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */
window.addEventListener('beforeunload', () => {
  if (realtimeSubscription) {
    console.log('üîå –û—Ç–ø–∏—Å–∫–∞ –æ—Ç Realtime –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
    realtimeSubscription.unsubscribe();
  }
});
```

---

### 7. Fallback –Ω–∞ club.json (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**:
- –ï—Å–ª–∏ `CONFIG.USE_SUPABASE = false` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (club.json polling)
- –ï—Å–ª–∏ Supabase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Üí fallback –Ω–∞ club.json
- –û—Å—Ç–∞–≤–ª—è–µ–º `club.json` –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞ —Å–ª—É—á–∞–π Supabase downtime)

**–ö–æ–¥ –≤ loadClubData()**:
```javascript
async function loadClubData() {
  const userId = getUserId();

  if (CONFIG.USE_SUPABASE) {
    // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: Supabase
    const payments = await loadUserPayments(userId);
    state.clubData = {
      zoom_link: CONFIG.CLUB_ZOOM_LINK, // –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ config.js
      payments: payments
    };
  } else {
    // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: club.json (fallback)
    const clubJson = await fetchClubJson();
    state.clubData = clubJson;
  }

  renderClubTab();
}
```

---

## üîÑ Make.com Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** (–Ω–µ Claude):

1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –≤ Make.com**:
   - Trigger: Webhook (YooKassa)
   - Action: HTTP Request ‚Üí POST –∫ Supabase REST API

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTP Request**:
   ```
   Method: POST
   URL: https://ujldixoiaqybtnifzhgy.supabase.co/rest/v1/club_payments

   Headers:
     apikey: {SUPABASE_ANON_KEY}
     Authorization: Bearer {SUPABASE_SERVICE_ROLE_KEY}
     Content-Type: application/json
     Prefer: return=representation

   Body (JSON):
   {
     "payment_id": "{{webhook.object.id}}",
     "telegram_user_id": {{webhook.object.metadata.telegram_user_id}},
     "amount": {{webhook.object.amount.value}},
     "status": "{{webhook.object.status}}",
     "payment_data": {{webhook.object}}
   }
   ```

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è** (Filter –º–æ–¥—É–ª—å –ø–µ—Ä–µ–¥ HTTP Request):
   ```javascript
   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ amount = 299000 (2990‚ÇΩ)
   webhook.object.amount.value === 299000

   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ status = 'succeeded'
   webhook.object.status === 'succeeded'

   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ telegram_user_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   webhook.object.metadata.telegram_user_id !== null
   ```

4. **Error handling**:
   - –ï—Å–ª–∏ HTTP Request –≤–µ—Ä–Ω—É–ª 4xx/5xx ‚Üí Send Email (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ Make.com History

**–í–∞–∂–Ω–æ**: `service_role` –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—å –≤ Make.com Environment Variables, –ù–ï –≤ –∫–æ–¥–µ —Å—Ü–µ–Ω–∞—Ä–∏—è!

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. Unit —Ç–µ—Å—Ç—ã (—Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Eruda DevTools)

**–¢–µ—Å—Ç—ã –¥–ª—è loadUserPayments()**:
```javascript
// –¢–µ—Å—Ç 1: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await loadUserPayments(156702946); // –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤

// –¢–µ—Å—Ç 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await loadUserPayments(999999999); // –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å []

// –¢–µ—Å—Ç 3: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º Supabase
CONFIG.USE_SUPABASE = false;
await loadUserPayments(156702946); // –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å [] –∏ warning
CONFIG.USE_SUPABASE = true;
```

**–¢–µ—Å—Ç—ã –¥–ª—è Realtime**:
```javascript
// –¢–µ—Å—Ç 1: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime
subscribeToPayments(156702946);
// ‚Üí –í –∫–æ–Ω—Å–æ–ª–∏: "‚úÖ Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞"

// –¢–µ—Å—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏—è (–≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Supabase Dashboard ‚Üí SQL Editor)
INSERT INTO club_payments (payment_id, telegram_user_id, amount, status)
VALUES ('test_realtime_001', 156702946, 299000, 'succeeded');
// ‚Üí –î–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å: Haptic + Popup + UI update

// –¢–µ—Å—Ç 3: –°–æ–±—ã—Ç–∏–µ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
INSERT INTO club_payments (payment_id, telegram_user_id, amount, status)
VALUES ('test_realtime_002', 123456789, 299000, 'succeeded');
// ‚Üí –ù–ï –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: "‚è≠Ô∏è –ü–ª–∞—Ç—ë–∂ –Ω–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: End-to-End –æ–ø–ª–∞—Ç–∞**:
1. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É "–ö–ª—É–±"
2. –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç 2990‚ÇΩ"
3. –û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Ñ–æ—Ä–º—É YooKassa
4. –û–ø–ª–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π (4111 1111 1111 1111)
5. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
   - < 1 —Å–µ–∫—É–Ω–¥—ã: Haptic feedback
   - Popup: "‚úÖ –ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!"
   - UI –æ–±–Ω–æ–≤–ª—ë–Ω: –ø–æ–∫–∞–∑–∞–Ω–∞ Zoom —Å—Å—ã–ª–∫–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Reconnect –ø–æ—Å–ª–µ –æ–±—Ä—ã–≤–∞ WebSocket**:
1. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É "–ö–ª—É–±" ‚Üí Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
2. –í–∫–ª—é—á–∏—Ç—å Airplane Mode –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
3. –í—ã–∫–ª—é—á–∏—Ç—å Airplane Mode
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
   - Supabase SDK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è
   - < 3 —Å–µ–∫—É–Ω–¥—ã –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: Fallback –Ω–∞ club.json**:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `CONFIG.USE_SUPABASE = false`
2. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É "–ö–ª—É–±"
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (fetch club.json)
   - Polling —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

### 3. RLS Security —Ç–µ—Å—Ç—ã

**–¢–µ—Å—Ç 1: –ü–æ–ø—ã—Ç–∫–∞ INSERT —Å anon –∫–ª—é—á–æ–º** (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è):
```javascript
const { data, error } = await supabaseClient
  .from('club_payments')
  .insert({
    payment_id: 'test_rls_001',
    telegram_user_id: 123,
    amount: 299000,
    status: 'succeeded'
  });

console.assert(error, 'RLS –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å INSERT!');
console.assert(error.code === '42501', '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ—à–∏–±–∫–∏ RLS');
```

**–¢–µ—Å—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ UPDATE —Å anon –∫–ª—é—á–æ–º** (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è):
```javascript
const { data, error } = await supabaseClient
  .from('club_payments')
  .update({ amount: 1 })
  .eq('payment_id', 'test_payment_001');

console.assert(error, 'RLS –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UPDATE!');
```

**–¢–µ—Å—Ç 3: SELECT —Ç–æ–ª—å–∫–æ succeeded –ø–ª–∞—Ç–µ–∂–µ–π**:
```javascript
// –í—Å—Ç–∞–≤–∏—Ç—å pending –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ SQL Editor (service_role)
INSERT INTO club_payments (payment_id, telegram_user_id, amount, status)
VALUES ('test_pending', 156702946, 299000, 'pending');

// –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å pending –ø–ª–∞—Ç—ë–∂ —Å anon –∫–ª—é—á–æ–º
const { data } = await supabaseClient
  .from('club_payments')
  .select('*')
  .eq('payment_id', 'test_pending');

console.assert(data.length === 0, 'RLS –¥–æ–ª–∂–µ–Ω —Å–∫—Ä—ã–≤–∞—Ç—å pending –ø–ª–∞—Ç–µ–∂–∏!');
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (T-005) | –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (T-006) | –ò–∑–º–µ—Ä–µ–Ω–∏–µ |
|---------|--------------------------|--------------------------|-----------|
| –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã | 4-5 –º–∏–Ω—É—Ç | < 1 —Å–µ–∫—É–Ω–¥–∞ | Performance.now() |
| WebSocket reconnect time | N/A | < 3 —Å–µ–∫—É–Ω–¥—ã | Supabase SDK events |
| Frontend bundle size | N/A | +50KB (Supabase SDK) | Network DevTools |
| API –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É | 50+ (polling) | 1 (initial fetch) | Network DevTools |
| Uptime | 99.9% (GitHub Pages) | 99.9% (Supabase SLA) | Statuspage |

---

## üöß Edge Cases –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 1. Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (downtime)

**–°—Ü–µ–Ω–∞—Ä–∏–π**: Supabase –ø—Ä–æ–µ–∫—Ç –≤ maintenance –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω quota.

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
```javascript
async function loadUserPayments(userId) {
  try {
    const { data, error } = await client.from('club_payments').select('*');

    if (error) {
      // –ü–æ–ø—ã—Ç–∫–∞ fallback –Ω–∞ club.json
      console.warn('‚ö†Ô∏è Supabase –æ—à–∏–±–∫–∞, fallback –Ω–∞ club.json');
      return await fetchClubJsonFallback();
    }

    return data;
  } catch (networkError) {
    console.error('‚ùå Network error, fallback –Ω–∞ club.json');
    return await fetchClubJsonFallback();
  }
}
```

### 2. WebSocket –æ–±—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ 30+ —Å–µ–∫—É–Ω–¥.

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
- Supabase SDK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è (exponential backoff)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ reconnect —Å–æ–±—ã—Ç–∏–π:
```javascript
.subscribe((status, error) => {
  if (status === 'CHANNEL_ERROR') {
    console.error('‚ùå WebSocket error:', error);
  } else if (status === 'TIMED_OUT') {
    console.warn('‚è±Ô∏è WebSocket timeout, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
  } else if (status === 'SUBSCRIBED') {
    console.log('‚úÖ WebSocket –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á—ë–Ω');
  }
});
```

### 3. –î—É–±–ª–∏—Ä—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ (race condition)

**–°—Ü–µ–Ω–∞—Ä–∏–π**: YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –¥–≤–∞–∂–¥—ã (retry).

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
- PostgreSQL constraint `UNIQUE (payment_id)` ‚Üí –≤—Ç–æ—Ä–æ–π INSERT –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è
- Make.com –¥–æ–ª–∂–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É 409 Conflict

### 4. –ü–ª–∞—Ç—ë–∂ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Realtime

**–°—Ü–µ–Ω–∞—Ä–∏–π**: Realtime push –ø–ª–∞—Ç—ë–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123, –Ω–æ —Ç–µ–∫—É—â–∏–π userId = 456.

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
```javascript
function handleRealtimePayment(payment, userId) {
  if (payment.telegram_user_id !== userId) {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º popup
    return;
  }
  // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
}
```

### 5. –ü—Ä–µ–≤—ã—à–µ–Ω Supabase Free Tier quota

**–°—Ü–µ–Ω–∞—Ä–∏–π**: > 2GB egress/–º–µ—Å—è—Ü –∏–ª–∏ > 500MB DB.

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
- Monitoring: Email –∞–ª–µ—Ä—Ç –ø—Ä–∏ 80% quota
- –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏: –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Pro –ø–ª–∞–Ω ($25/–º–µ—Å—è—Ü)
- –í—Ä–µ–º–µ–Ω–Ω—ã–π fallback: club.json (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—á–µ–∫-–ª–∏—Å—Ç)

- [x] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã (`ENABLE ROW LEVEL SECURITY`)
- [x] `anon` –∫–ª—é—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- [x] `service_role` –∫–ª—é—á –ù–ï –≤ config.js (—Ç–æ–ª—å–∫–æ Make.com env vars)
- [x] HTTPS –¥–ª—è –≤—Å–µ—Ö endpoints
- [x] SQL constraints (unique, check)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ Make.com (TODO: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Filter)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (TODO: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Database Webhooks)
- [x] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã (‚úÖ —Ç–µ—Å—Ç—ã –≤—ã—à–µ)
- [ ] Rate limiting –ø—Ä–æ–≤–µ—Ä–µ–Ω (TODO: —Å–ø–∞–º-—Ç–µ—Å—Ç)
- [ ] CORS/Origin –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìù –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

**–§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞** (5 –∑–∞–¥–∞—á)
1. –î–æ–±–∞–≤–∏—Ç—å Supabase SDK –≤ index.html
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ config.js
3. –°–æ–∑–¥–∞—Ç—å initSupabase() –≤ app.js
4. –°–æ–∑–¥–∞—Ç—å loadUserPayments() –≤ app.js
5. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å loadUserPayments() –≤ loadClubData()

**–§–∞–∑–∞ 2: Realtime –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** (4 –∑–∞–¥–∞—á–∏)
6. –°–æ–∑–¥–∞—Ç—å subscribeToPayments() –≤ app.js
7. –°–æ–∑–¥–∞—Ç—å handleRealtimePayment() –≤ app.js
8. –°–æ–∑–¥–∞—Ç—å updateClubUIAfterPayment() –≤ app.js
9. –î–æ–±–∞–≤–∏—Ç—å cleanup (beforeunload)

**–§–∞–∑–∞ 3: Make.com Backend** (2 –∑–∞–¥–∞—á–∏, –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!)
10. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Make.com –º–æ–¥—É–ª—å (HTTP POST ‚Üí Supabase)
11. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ error handling

**–§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (5 –∑–∞–¥–∞—á)
12. Unit —Ç–µ—Å—Ç—ã (loadUserPayments, Realtime)
13. RLS security —Ç–µ—Å—Ç—ã (INSERT/UPDATE/DELETE)
14. End-to-End —Ç–µ—Å—Ç (—Ä–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
15. Edge cases (Supabase downtime, WebSocket reconnect)
16. Performance —Ç–µ—Å—Ç—ã (–≤—Ä–µ–º—è –æ—Ç –æ–ø–ª–∞—Ç—ã –¥–æ UI update)

**–§–∞–∑–∞ 5: –î–µ–ø–ª–æ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (3 –∑–∞–¥–∞—á–∏)
17. Commit –∏–∑–º–µ–Ω–µ–Ω–∏–π: `[T-006] Supabase PostgreSQL + Realtime –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è`
18. Deploy –Ω–∞ GitHub Pages
19. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Supabase Dashboard ‚Üí Alerts)

**–ò—Ç–æ–≥–æ**: 19 –∑–∞–¥–∞—á (14 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, 2 –±—ç–∫–µ–Ω–¥, 3 –∏–Ω—Ñ—Ä–∞)

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–¢–∏–∫–µ—Ç T-006 —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º –∫–æ–≥–¥–∞:

- [ ] –í—Å–µ 19 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] Realtime —Ä–∞–±–æ—Ç–∞–µ—Ç (< 1 —Å–µ–∫—É–Ω–¥–∞ –æ—Ç –ø–ª–∞—Ç–µ–∂–∞ –¥–æ UI update)
- [ ] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞—â–∏—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] Make.com webhook –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] Edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (fallback, reconnect)
- [ ] –ö–æ–¥ –ø—Ä–æ—à—ë–ª —Ä–µ–≤—å—é
- [ ] Deployed –Ω–∞ production
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã (< 1 —Å–µ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (README)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- Supabase Realtime: https://supabase.com/docs/guides/realtime
- Supabase RLS: https://supabase.com/docs/guides/auth/row-level-security
- Supabase JS Client: https://supabase.com/docs/reference/javascript/introduction
- Make.com HTTP Module: https://www.make.com/en/help/tools/http

**Troubleshooting**:
- Realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `ALTER PUBLICATION supabase_realtime ADD TABLE`
- RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç SELECT ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É `USING (status = 'succeeded')`
- Make.com –æ—à–∏–±–∫–∞ 401 ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `service_role` –∫–ª—é—á –≤ headers

---

**–ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏! üöÄ**
