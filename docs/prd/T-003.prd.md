# PRD: Интеграция платежной системы Юкасса

**Тикет**: T-003
**Дата создания**: 2026-02-07
**Статус**: PRD_READY

---

## Краткое описание

Интеграция платежной системы Юкасса для приема оплаты консультаций с временной блокировкой слотов (TTL 24 часа) до подтверждения оплаты.

---

## Проблема / Возможность

### Контекст

Пользователи бронируют консультации, но не оплачивают их сразу. Слоты блокируются навсегда, даже если оплата не прошла, что приводит к потере потенциальных клиентов.

### Текущая ситуация (AS IS)

1. Пользователь выбирает слот
2. Слот сразу помечается как `book` в slots.json
3. Оплата не требуется (или происходит позже)
4. Слот заблокирован навсегда, даже без оплаты

**Проблемы**:
- Слоты блокируются без гарантии оплаты
- Нет механизма автоматической разблокировки
- Потеря потенциальных клиентов из-за занятых, но не оплаченных слотов

### Желаемая ситуация (TO BE)

1. Пользователь выбирает слот
2. Make.com удаляет слот из slots.json (скрывает от других пользователей)
3. Make.com сохраняет слот в Data Store/Google Sheets со статусом `locking` и TTL 24 часа
4. Пользователь получает ссылку на оплату через Юкассу
5. **Сценарий A (оплата прошла)**:
   - Юкасса отправляет webhook в Make.com
   - Make.com обновляет слот в Data Store: `status: "book"`, убирает TTL
   - Создаёт Zoom встречу и добавляет в Google Calendar
   - Пользователь получает приглашение с ссылкой на Zoom
6. **Сценарий B (оплата не прошла)**:
   - Через 24 часа Make.com возвращает слот обратно в slots.json (делает доступным)
   - Удаляет запись из Data Store

**Преимущества**:
- Честная блокировка слотов только для оплативших
- Автоматическая разблокировка через 24 часа
- Увеличение конверсии в оплату
- Прозрачность для пользователя

---

## Требования

### Функциональные требования

#### Must Have (обязательно)

- [ ] Новый статус слота: `locking` (временная блокировка)
- [ ] Поле `locked_until` с временной меткой (timestamp) окончания блокировки
- [ ] Поле `user_id` в структуре слота (для привязки к пользователю Telegram)
- [ ] Интеграция с Юкасса API через Make.com для создания платежа
- [ ] Отображение платежного окна в приложении (ссылка Юкассы)
- [ ] Webhook от Юкассы в Make.com при успешной оплате
- [ ] Make.com сценарий: обновление слота `locking` → `book` при оплате
- [ ] Make.com сценарий: TTL мониторинг (каждый час) для разблокировки просроченных слотов
- [ ] Визуальное отображение статуса `locking` (бледно-красный, полупрозрачный)

#### Should Have (желательно)

- [ ] Таймер обратного отсчета для пользователя (показывает оставшееся время)
- [ ] Уведомление пользователю за 1 час до истечения TTL
- [ ] История платежей в "Мои записи"
- [ ] Возможность отменить бронирование до оплаты

#### Could Have (можно добавить позже)

- [ ] Повторная попытка оплаты (если первая не прошла)
- [ ] Рассрочка через Юкассу
- [ ] Альтернативные способы оплаты (СБП, карты)

### Нефункциональные требования (NFR)

**Производительность**:
- Создание платежа через Юкассу < 3 секунд
- Обработка webhook от Юкассы < 2 секунд
- Обновление slots.json в git < 5 секунд

**Надежность**:
- При ошибке Юкассы — показать пользователю понятное сообщение
- При ошибке webhook — retry 3 раза с экспоненциальным backoff

**Безопасность**:
- API ключи Юкассы хранятся только в Make.com (не в коде)
- Webhook от Юкассы подписан (проверка подписи)
- `user_id` из Telegram используется только для идентификации

**UX/UI**:
- Платежное окно открывается в Telegram WebView
- Соответствие beige-палитре проекта
- HapticFeedback при успешной оплате

---

## Сценарии использования

### Основной сценарий (Happy Path)

**Действующие лица**: Пользователь, Фронтенд, Make.com, Юкасса, Git

**Предусловия**:
- Пользователь авторизован в Telegram
- Выбрана услуга и доступный слот

**Шаги**:

1. Пользователь выбирает слот и нажимает "Забронировать"
2. Фронтенд отправляет запрос в Make.com:
   ```json
   {
     "slot_id": "pslot_01",
     "user_id": "123456789",
     "service": "package"
   }
   ```
3. Make.com:
   - Принимает выбранный слот (все слоты в slots.json изначально free)
   - Удаляет слот из slots.json на GitHub (убираем из показа другим пользователям)
   - Сохраняет слот в Data Store/Google Sheets со статусом "locking":
     ```json
     {
       "id": "pslot_01",
       "status": "locking",
       "user_id": "123456789",
       "locked_until": "2026-02-08T10:00:00Z"
     }
     ```
   - Создаёт платеж в Юкассе:
     ```json
     {
       "amount": { "value": "75000.00", "currency": "RUB" },
       "confirmation": { "type": "redirect", "return_url": "https://..." },
       "description": "Пакет консультаций",
       "metadata": { "slot_id": "pslot_01", "user_id": "123456789" }
     }
     ```
   - Возвращает фронтенду:
     ```json
     {
       "success": true,
       "payment_url": "https://yookassa.ru/checkout/payments/xxx"
     }
     ```

4. Фронтенд открывает платежную ссылку в Telegram WebView
5. Пользователь оплачивает через Юкассу
6. Юкасса отправляет webhook в Make.com:
   ```json
   {
     "event": "payment.succeeded",
     "object": {
       "id": "payment_xxx",
       "status": "succeeded",
       "metadata": { "slot_id": "pslot_01", "user_id": "123456789" }
     }
   }
   ```
7. Make.com:
   - Обновляет Data Store/Google Sheets:
     ```json
     {
       "id": "pslot_01",
       "status": "book",
       "user_id": "123456789"
       // locked_until удалено
     }
     ```
   - Создаёт встречу в Zoom и добавляет в Google Calendar психолога
   - Отправляет уведомление пользователю с приглашением и ссылкой

8. Фронтенд показывает подтверждение с HapticFeedback
9. Пользователь видит запись в "Мои записи"

**Результат**:
- Слот забронирован и оплачен
- Пользователь получил приглашение на Zoom
- JSON обновлён (`status: "book"`)

---

### Альтернативные сценарии

#### Сценарий 2: Пользователь не оплатил в течение 24 часов

1. Пользователь получил ссылку на оплату, но не оплатил
2. Make.com запускает cron-задачу каждый час:
   ```javascript
   // Псевдокод
   const now = new Date();
   slots.forEach(slot => {
     if (slot.status === 'locking' && new Date(slot.locked_until) < now) {
       slot.status = 'free';
       delete slot.user_id;
       delete slot.locked_until;
     }
   });
   // Коммит в git
   ```
3. Слот становится доступным для других пользователей
4. Пользователь видит уведомление: "Время бронирования истекло. Слот освобожден."

---

#### Сценарий 3: Пользователь пытается забронировать уже locked слот

1. Пользователь A забронировал слот (status: `locking`)
2. Пользователь B пытается забронировать тот же слот
3. Make.com проверяет:
   - Слот в статусе `locking`
   - `locked_until` ещё не истёк
4. Make.com возвращает ошибку:
   ```json
   {
     "success": false,
     "error": "slot_locked",
     "message": "Слот временно заблокирован другим пользователем"
   }
   ```
5. Фронтенд показывает:
   - "Этот слот сейчас оформляется другим пользователем. Попробуйте выбрать другое время."

---

### Исключительные ситуации (Edge Cases)

**Ошибка 1**: Юкасса не отвечает (timeout)
- **Причина**: Технические проблемы Юкассы
- **Обработка**: Make.com ждет 10 секунд, затем возвращает ошибку
- **Сообщение пользователю**: "Сервис оплаты временно недоступен. Попробуйте позже."

**Ошибка 2**: Webhook от Юкассы не пришёл
- **Причина**: Сетевая ошибка
- **Обработка**: Юкасса повторяет webhook до 3 раз (с задержкой)
- **Fallback**: Пользователь может запросить проверку статуса оплаты в "Мои записи"

**Ошибка 3**: Платёж отклонён банком
- **Причина**: Недостаточно средств / неверные данные карты
- **Обработка**:
  - Юкасса возвращает статус `canceled`
  - Make.com оставляет слот в `locking` (у пользователя ещё есть время)
  - Пользователь видит: "Оплата не прошла. Попробуйте другую карту или способ оплаты."

**Ошибка 4**: Race condition (два запроса одновременно)
- **Причина**: Два пользователя кликают на один слот одновременно
- **Обработка**: Make.com использует git pull → проверка наличия слота → удаление → commit
- **Результат**: Первый успешен, второй получает `slot_not_found` (слот уже занят)

---

## Структура данных

### Формат slots.json (только free слоты)

**Важно**: slots.json содержит ТОЛЬКО свободные слоты. Слоты со статусом `locking` и `book` удаляются из этого файла.

```json
{
  "generated_at": "2026-02-07T10:00:00Z",
  "slots": [
    {
      "id": "pslot_01",
      "date": "03.02.2026",
      "time": "10:00",
      "service": "package"
    },
    {
      "id": "fslot_01",
      "date": "03.02.2026",
      "time": "12:00",
      "service": "family"
    }
  ]
}
```

### Формат Data Store/Google Sheets (locking и book слоты)

```json
{
  "id": "pslot_02",
  "date": "03.02.2026",
  "time": "14:00",
  "service": "package",
  "status": "locking",
  "user_id": "123456789",
  "locked_until": "2026-02-08T14:00:00Z"
}
```

или

```json
{
  "id": "pslot_03",
  "date": "03.02.2026",
  "time": "16:00",
  "service": "package",
  "status": "book",
  "user_id": "987654321",
  "zoom_link": "https://zoom.us/j/123456789"
}
```

### Новые поля слота

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `status` | string | Обязательно | `free` / `locking` / `book` |
| `user_id` | string | Только для `locking` и `book` | Telegram user ID |
| `locked_until` | string (ISO 8601) | Только для `locking` | Время окончания блокировки |

### Статусы слотов (обновлено)

| Статус | Описание | Дополнительные поля |
|--------|----------|---------------------|
| `free` | Свободен для бронирования | — |
| `locking` | Временно заблокирован (ожидание оплаты) | `user_id`, `locked_until` |
| `book` | Забронирован и оплачен | `user_id` |

---

## UI/UX Дизайн

### Основные элементы интерфейса

**Экран 1: Выбор слота**
- Слоты с `status: "free"` — белый фон, полная непрозрачность (загружаются из slots.json)
- Слоты с `status: "locking"` — НЕ отображаются (удалены из slots.json)
- Слоты с `status: "book"` — НЕ отображаются (удалены из slots.json)

**Экран 2: Подтверждение бронирования**
- Кнопка MainButton "Забронировать" (текст не меняется)
- При клике создаётся платёж и сразу открывается Telegram WebView с URL Юкассы
- Если пользователь закрыл окно, может вернуться через "Мои записи" и оплатить

**Экран 3: Платёжное окно (Юкасса)**
- Стандартный интерфейс Юкассы
- После оплаты → автоматический возврат в приложение

**Экран 4: "Мои записи"**
- Слоты в статусе `locking` показываются с таймером:
  - "Ожидает оплаты. Осталось: 23 ч 15 мин"
  - Кнопка "Оплатить" (повторная ссылка)
- Слоты в статусе `book` — обычный вид с Zoom-ссылкой

### Взаимодействия

- **Клик на "Оплатить"**: HapticFeedback (`impactOccurred('medium')`), открытие WebView
- **Успешная оплата**: HapticFeedback (`notificationOccurred('success')`), показ подтверждения
- **Ошибка оплаты**: HapticFeedback (`notificationOccurred('error')`), сообщение с причиной

---

## Зависимости

### Внешние системы

- **Юкасса API**:
  - Создание платежа (POST `/payments`)
  - Webhook для подтверждения оплаты
- **Make.com**:
  - Сценарий создания платежа
  - Webhook-приёмник от Юкассы
  - Cron-задача для TTL мониторинга (каждый час)
- **GitHub API**: Обновление slots.json при изменении статуса
- **Telegram WebApp API**: Открытие платёжной ссылки в WebView

### Внутренние зависимости

- **Файлы**:
  - `app.js` (логика бронирования и оплаты)
  - `slots.json` (слоты удаляются при locking/book, остаются только free)
  - `style.css` (стили для статуса `locking` в "Моих записях")
- **Компоненты**: Функции работы со слотами, календарь
- **Другие тикеты**:
  - T-002 завершён (slots.json в git)

---

## Метрики успеха

### Как измерим успех фичи?

**Количественные метрики**:
- Конверсия в оплату > 60% (от нажатия "Оплатить" до успешной оплаты)
- Процент автоматически разблокированных слотов < 30%
- Время от клика "Оплатить" до открытия Юкассы < 3 секунд

**Качественные метрики**:
- Пользователи понимают, что слот временно заблокирован
- Нет жалоб на "украденные" слоты
- Прозрачность процесса оплаты

---

## Риски и ограничения

### Технические риски

- **Риск 1**: Webhook от Юкассы не доходит
  - **Вероятность**: Средняя
  - **Влияние**: Высокое (слот останется в `locking` навсегда)
  - **Митигация**:
    - Retry-логика Юкассы (3 попытки)
    - Fallback: пользователь может запросить проверку оплаты
    - Cron-задача проверяет статус оплаты через API Юкассы

- **Риск 2**: Race condition при обновлении slots.json
  - **Вероятность**: Низкая
  - **Влияние**: Критическое (двойное бронирование)
  - **Митигация**:
    - git pull + проверка + commit
    - Атомарные операции в Make.com

- **Риск 3**: Пользователь закрывает приложение до завершения оплаты
  - **Вероятность**: Высокая
  - **Влияние**: Среднее
  - **Митигация**:
    - Слот остаётся в `locking` 24 часа
    - Пользователь может вернуться и оплатить позже

### Ограничения

- Юкасса комиссия: ~2.8% от суммы
- Webhook URL должен быть публичным (Make.com предоставляет)
- TTL проверка — раз в час (не реал-тайм), небольшая задержка допустима

---

## Открытые вопросы

_Все вопросы закрыты. См. раздел "Решения и уточнения"._

---

## Решения и уточнения

### 2026-02-07 — Создание PRD

Создан первичный PRD на основе требований пользователя.

### 2026-02-07 — Закрыты открытые вопросы

**Вопрос 1: Цены на услуги**
- `diagnosis`: 0 руб (бесплатно, как и было)
- `package`: **75 000 руб**
- `family`: **10 000 руб**
- `single`: **8 000 руб**

**Вопрос 2: Кнопка отмены бронирования**
- Решение: **Делаем в самом конце** (вынесем в отдельную задачу после основной функциональности)
- Пока не блокирует основную разработку

**Вопрос 3: Отображение locking слотов для других пользователей**
- Решение: **Вариант A - Не показывать** (как будто `book`)
- Обоснование: Упрощает UI и не вводит пользователей в заблуждение

### 2026-02-07 — Финальный UX флоу и action name

**Вопрос 4: UX флоу бронирования**
- Решение: MainButton остаётся с текстом **"Забронировать"** (не меняем на "Оплатить X руб")
- При клике сразу создаётся платёж и открывается WebView с Юкассой
- Если пользователь закрыл окно, может оплатить через "Мои записи"

**Вопрос 5: Название action для Make.com webhook**
- Решение: **`create_payment`**
- Используется для идентификации запроса на создание платежа в Make.com

---

## История изменений

**2026-02-07**
- **Версия**: DRAFT
- **Изменения**: Первоначальная версия PRD

**2026-02-07**
- **Версия**: PRD_READY
- **Изменения**:
  - Закрыты все открытые вопросы
  - Добавлены цены на услуги
  - Принято решение по отображению locking слотов
  - Статус изменён на PRD_READY

---

## Чек-лист готовности PRD

Перед переходом к этапу планирования убедись:

- [x] Понятна проблема и цель фичи
- [x] Описаны все must-have требования
- [x] Расписан happy path и основные edge cases
- [x] Определены метрики успеха
- [x] Выявлены риски и зависимости
- [x] Все блокирующие вопросы закрыты (см. "Открытые вопросы")
- [x] Статус изменён на `PRD_READY`

**PRD готов! Можно переходить к реализации.**
