# PRD: Пакет консультаций — бронирование без повторной оплаты

**Тикет**: T-010
**Автор**: Андрей Селезнев
**Дата создания**: 2026-02-17
**Статус**: PRD_READY

---

## Краткое описание

Клиент, оплативший пакет из 10 консультаций, должен иметь возможность бронировать последующие 9 сессий без повторной оплаты. Система запоминает остаток сессий в Supabase и пропускает экран оплаты при наличии активного пакета.

---

## Проблема / Возможность

### Контекст

Услуга "Пакет консультаций" стоит 75 000 ₽ и включает 10 сессий. Клиент платит один раз, но бронирует сессии постепенно. Сейчас система не отслеживает оплаченный пакет — при каждом новом бронировании пользователь видит экран оплаты, что нарушает UX и может приводить к повторным списаниям.

### Текущая ситуация (AS IS)

1. Пользователь выбирает "Пакет консультаций" → бронирует слот
2. Проходит оплата 75 000 ₽ → Сценарий 2 (book) → Zoom invite
3. Пользователь выходит → заходит снова → хочет записаться на следующую сессию
4. **Система снова показывает оплату** → нет информации об оплаченном пакете

### Желаемая ситуация (TO BE)

1. Первая оплата пакета → Сценарий 2 (book) записывает в Supabase `sessions_remaining = 9`
2. При следующем входе фронтенд проверяет Supabase: есть ли активный пакет?
3. Если да → скрыть оплату, показать кнопку "Записаться" + бейджик "Осталось 9 сессий"
4. Бронирование уходит в Сценарий 2 с флагом `package_session` → декремент счётчика → Zoom invite

---

## Требования

### Функциональные требования

#### Must Have

- [ ] При первой оплате пакета — INSERT в `user_packages` (sessions_remaining = 9)
- [ ] При загрузке приложения — проверка активного пакета по `telegram_user_id`
- [ ] При наличии пакета — скрыть экран оплаты, показать "Осталось N сессий"
- [ ] Бронирование из пакета → UPDATE sessions_remaining - 1 в Supabase
- [ ] Сценарий 2 (book) в Make.com: роутер `package_first` / `package_session` / `regular`
- [ ] Отправка Zoom invite для package_session без платёжного вебхука

#### Should Have

- [ ] Показывать количество оставшихся сессий на карточке услуги
- [ ] Уведомление когда осталась 1 сессия: "Последняя сессия из пакета"
- [ ] Если пакет исчерпан (0 сессий) — стандартный флоу с оплатой новой услуги
- [ ] При отмене сессии из пакета — `sessions_remaining + 1` + INSERT в `package_events` (event_type: 'cancelled')
- [ ] Отмена через стандартную кнопку в "Мои записи" — без изменений UX, только добавляется логика возврата сессии в пакет

### Не функциональные требования (NFR)

**Производительность**:
- Проверка пакета в Supabase не должна блокировать загрузку UI (асинхронно)

**Безопасность**:
- Идентификация исключительно по `telegram_user_id` из Telegram WebApp (не редактируется пользователем)
- Нельзя обойти проверку через прямой вызов Make.com webhook без `user_id`

**UX/UI**:
- Соответствие beige палитре
- Бейджик "Осталось N сессий" — лаконичный, не перегружает интерфейс

---

## Сценарии использования

### Основной сценарий: первая оплата пакета (Happy Path)

**Предусловия**: пользователь не имеет активного пакета в `user_packages`

**Шаги**:
1. Пользователь выбирает "Пакет консультаций" → нажимает "Записаться"
2. Выбирает слот → переходит к оплате 75 000 ₽
3. Оплата проходит → Сценарий 2 (book) срабатывает
4. **Новый модуль**: Supabase INSERT `user_packages` (sessions_remaining = 9)
5. Пользователь получает Zoom invite на первую сессию

**Результат**: пакет активирован, 9 сессий остаётся

---

### Сценарий 2: последующее бронирование из пакета

**Предусловия**: пользователь имеет `sessions_remaining > 0` в `user_packages`

**Шаги**:
1. Пользователь открывает приложение → фронтенд запрашивает Supabase
2. Ответ: `sessions_remaining = 7` → скрыть оплату
3. На карточке пакета отображается "Осталось 7 сессий из 10"
4. Пользователь нажимает "Записаться" → выбирает слот
5. Запрос уходит в Make.com с флагом `payment_type: package_session`
6. Сценарий 2: роутер → ветка `package_session` → Supabase UPDATE sessions_remaining - 1
7. Пользователь получает Zoom invite

**Результат**: sessions_remaining = 6, новый Zoom invite получен, оплаты нет

---

### Сценарий 3: пакет исчерпан

**Шаги**:
1. Пользователь открывает приложение → Supabase: `sessions_remaining = 0`
2. Стандартный флоу с оплатой
3. Опционально: предложить купить новый пакет

---

### Edge Cases

**Ошибка 0**: Отмена сессии из пакета
- **Обработка**: стандартная кнопка "Отменить запись" в "Мои записи" → Make.com сценарий отмены → Supabase UPDATE sessions_remaining + 1 + INSERT package_events (cancelled)
- **Нет возвратов денег** — сессия возвращается в пакет, не деньги

**Ошибка 1**: Supabase недоступен при проверке пакета
- **Причина**: сетевая ошибка или Supabase downtime
- **Обработка**: fallback → стандартный флоу с оплатой (безопаснее, чем пропустить оплату)
- **Сообщение пользователю**: стандартный экран бронирования без уведомлений об ошибке

**Ошибка 2**: Двойное бронирование — пользователь дважды нажал "Записаться"
- **Обработка**: Make.com сценарий 3 (locking) уже блокирует повторное занятие слота

**Ошибка 3**: Пользователь оплатил пакет, но вебхук в Supabase не сработал
- **Обработка**: Make.com должен иметь retry на Supabase модуле (3 попытки)
- **Митигация**: логировать все вызовы INSERT в Make.com

**Ошибка 4**: Рассинхрон счётчика (sessions_remaining < 0)
- **Обработка**: CHECK constraint в Supabase: `sessions_remaining >= 0`

---

## UI/UX Дизайн

### Основные элементы интерфейса

- **Карточка "Пакет консультаций"**: добавить бейджик "Осталось N / 10 сессий" под ценой (если пакет активен)
- **Кнопка "Записаться"**: поведение не меняется, меняется только то, куда ведёт (минуя оплату)
- **Экран подтверждения**: тот же, что и сейчас — Zoom invite

### Взаимодействия

- **Загрузка вкладки "Услуги"**: асинхронно запрашиваем Supabase, показываем бейджик после ответа
- **Haptic Feedback**: без изменений — `notificationOccurred('success')` при подтверждении

---

## Зависимости

### Внешние системы

- **Make.com Сценарий 2 (book)**: добавить роутер на `payment_type` + 2 Supabase модуля
- **Supabase**: новая таблица `user_packages`

### Внутренние зависимости

- **`app.js`**: функция загрузки вкладки Услуги — добавить запрос к Supabase, изменить флоу бронирования пакета
- **`styles.css`**: стиль бейджика "Осталось N сессий"

---

## Структура данных Supabase

### Существующие таблицы (проверено 2026-02-17)
- `user_consents` — согласия на ПД, поле `telegram_user_id BIGINT`
- `club_payments` — платежи клуба, поля: `telegram_user_id`, `payment_id`, `status`, `payment_data JSONB`, `zoom_link`

### Новые таблицы для T-010

```sql
-- Основная таблица пакетов (один активный пакет на пользователя)
CREATE TABLE user_packages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_user_id BIGINT NOT NULL,
    payment_id TEXT NOT NULL,                  -- ID платежа YooKassa (связь с оплатой)
    sessions_total INT NOT NULL DEFAULT 10,
    sessions_remaining INT NOT NULL DEFAULT 9, -- 9 т.к. первая сессия уже забронирована
    status TEXT NOT NULL DEFAULT 'active',     -- active | exhausted
    payment_data JSONB,                        -- доп. данные от YooKassa (как в club_payments)
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT sessions_non_negative CHECK (sessions_remaining >= 0)
);

CREATE INDEX idx_user_packages_telegram_user_id ON user_packages(telegram_user_id);

-- Лог событий пакета: бронирования и отмены
CREATE TABLE package_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    package_id UUID NOT NULL REFERENCES user_packages(id),
    telegram_user_id BIGINT NOT NULL,
    event_type TEXT NOT NULL,   -- 'booked' | 'cancelled'
    booking_id TEXT,            -- ID бронирования из Make.com (для связи)
    session_date TEXT,          -- дата сессии "YYYY-MM-DD"
    session_time TEXT,          -- время "HH:MM"
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_package_events_package_id ON package_events(package_id);
CREATE INDEX idx_package_events_telegram_user_id ON package_events(telegram_user_id);
```

---

## Метрики успеха

**Количественные**:
- Клиенты с пакетом не видят экран оплаты при повторном бронировании
- sessions_remaining корректно уменьшается после каждой сессии
- Нет дублирующих записей для одного user_id (проверять логами Make.com)

---

## Риски и ограничения

- **Риск 1**: Supabase вебхук в Make.com не сработал при первой оплате
  - **Вероятность**: Низкая
  - **Влияние**: Высокое (пакет не активируется)
  - **Митигация**: retry в Make.com + мониторинг через логи

- **Риск 2**: Рассинхрон если один пользователь бронирует с двух устройств одновременно
  - **Вероятность**: Очень низкая
  - **Митигация**: atomic UPDATE в Supabase (WHERE sessions_remaining > 0)

### Ограничения

- У пользователя может быть только один активный пакет одновременно (упрощение для v1)
- Сценарий возврата/отмены сессии из пакета — вне scope T-010

---

## История изменений

Дата: 2026-02-17
Версия: 1.0
Изменения: Создание PRD

---

## Чек-лист готовности PRD

- [x] Понятна проблема и цель фичи
- [x] Описаны все must-have требования
- [x] Расписан happy path и основные edge cases
- [x] Определены метрики успеха
- [x] Выявлены риски и зависимости
- [x] Все блокирующие вопросы закрыты
- [x] Статус изменён на `PRD_READY`
