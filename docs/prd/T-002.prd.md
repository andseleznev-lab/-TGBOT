# PRD: Хранение слотов в Git (JSON)

**Тикет**: T-002
**Дата создания**: 2026-02-02
**Статус**: PRD_READY

## Краткое описание

Перенос хранения доступных слотов из Make.com в Git-репозиторий в виде JSON файла. Make.com формирует структуру слотов, а пометка "занято" происходит через обновление файла в Git.

## Проблема / Возможность

### Контекст

Сейчас доступность слотов проверяется через Make.com при каждом запросе. Это создаёт:
- Задержки при загрузке расписания
- Зависимость от доступности Make.com
- Расход операций Make.com на каждый просмотр
- Риск race condition при одновременных бронированиях

### Текущая ситуация (AS IS)

1. Пользователь открывает календарь
2. Фронтенд запрашивает слоты у Make.com
3. Make.com собирает данные из Google Calendar / Sheets
4. Make.com возвращает список доступных слотов
5. При бронировании — повторный запрос к Make.com

**Проблемы**:
- Каждый запрос = операции Make.com
- Медленно (несколько секунд на загрузку)
- Нет единого источника правды о занятости

### Желаемая ситуация (TO BE)

1. Make.com периодически генерирует JSON со слотами и коммитит в Git
2. Фронтенд читает JSON напрямую из репозитория (GitHub raw / CDN)
3. При бронировании: обновляем JSON в Git (status: "book")
4. Make.com синхронизирует занятые слоты с Google Calendar

**Преимущества**:
- Мгновенная загрузка слотов (статический файл)
- Снижение нагрузки на Make.com
- Единый источник правды в Git
- История изменений (git log)
- Возможность работать офлайн (кеш)

## Требования

### Функциональные требования

#### Must Have (обязательно)

- [ ] JSON-файл со структурой слотов в репозитории (`data/slots.json`)
- [ ] Make.com сценарий генерации/обновления JSON
- [ ] Механизм пометки слота как занятого (через GitHub API или Make.com)
- [ ] Фронтенд читает слоты из JSON вместо запроса к Make.com
- [ ] Синхронизация занятых слотов с Google Calendar

#### Should Have (желательно)

- [ ] Кеширование JSON на фронтенде (localStorage / sessionStorage)
- [ ] Версионирование JSON (timestamp / etag для инвалидации кеша)
- [ ] Резервный fallback на Make.com API при недоступности JSON

#### Could Have (можно добавить позже)

- [ ] Webhook для автоматического обновления при изменениях в Calendar
- [ ] Оптимистичный UI (показываем занятость до подтверждения)
- [ ] Разделение JSON по услугам/месяцам для оптимизации размера

### Нефункциональные требования (NFR)

**Производительность**:
- Загрузка слотов < 500ms (статический файл)
- Размер JSON < 50KB (сжатый)
- Обновление JSON при бронировании < 3 секунд

**Надёжность**:
- При конфликте записи — повторная попытка
- Блокировка слота на время бронирования (prevent double-booking)

**Безопасность**:
- JSON не содержит персональных данных клиентов
- Запись в Git только через авторизованный сценарий Make.com

**Совместимость**:
- Формат JSON совместим с текущим API ответом Make.com
- Обратная совместимость на период миграции

## Сценарии использования

### Основной сценарий (Happy Path)

**Действующие лица**: Пользователь, Фронтенд, Git, Make.com

**Предусловия**:
- JSON со слотами актуален в репозитории
- Пользователь выбрал услугу

**Шаги**:
1. Пользователь открывает выбор даты
2. Фронтенд запрашивает `data/slots.json` из GitHub raw
3. Фронтенд отображает доступные даты/слоты
4. Пользователь выбирает слот и подтверждает бронирование
5. Фронтенд отправляет запрос на бронирование в Make.com
6. Make.com обновляет `slots.json` в Git (status: "book")
7. Make.com создаёт событие в Google Calendar
8. Пользователь видит подтверждение

**Результат**:
- Слот забронирован
- JSON обновлён
- Calendar синхронизирован

### Альтернативные сценарии

#### Сценарий 2: Кеш устарел

1. Фронтенд загружает JSON из кеша
2. При бронировании Make.com обнаруживает, что слот уже занят
3. Make.com возвращает ошибку "slot_taken"
4. Фронтенд перезагружает JSON, показывает актуальные слоты
5. Пользователь выбирает другой слот

### Исключительные ситуации (Edge Cases)

**Ошибка 1**: Конфликт записи в Git (два бронирования одновременно)
- **Причина**: Параллельные коммиты в один файл
- **Обработка**: Make.com делает pull, merge, повторный push
- **Сообщение пользователю**: "Подождите, проверяем доступность..."

**Ошибка 2**: GitHub API недоступен
- **Причина**: Временные проблемы GitHub
- **Обработка**: Fallback на прямой запрос к Make.com
- **Сообщение пользователю**: Не показываем, работаем в фоне

**Ошибка 3**: JSON повреждён или невалидный
- **Причина**: Ошибка при генерации
- **Обработка**: Fallback на Make.com API, алерт администратору
- **Сообщение пользователю**: "Загрузка расписания..."

## Структура данных

### Формат slots.json

```json
{
  "generated_at": "2026-02-02T16:44:00Z",
  "slots": [
    {
      "id": "slot_01",
      "date": "2026-02-03",
      "time": "10:00",
      "service": "package",
      "status": "free"
    },
    {
      "id": "slot_02",
      "date": "2026-02-03",
      "time": "12:00",
      "service": "single",
      "status": "book"
    },
    {
      "id": "slot_03",
      "date": "2026-02-03",
      "time": "14:00",
      "service": "family",
      "status": "free"
    }
  ]
}
```

### Поля слота

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный ID слота (slot_01, slot_02...) |
| `date` | string | Дата в формате YYYY-MM-DD |
| `time` | string | Время начала (HH:MM) |
| `service` | string | Тип услуги (package, single, family, diagnose...) |
| `status` | string | Статус: `free` или `book` |

### Статусы слотов

| Статус | Описание |
|--------|----------|
| `free` | Свободен для бронирования |
| `book` | Забронирован |

### Принцип минимальности

В JSON хранятся **только данные для отображения**. Персональные данные (client_name, telegram_id, zoom_link) остаются в Google Sheets и не попадают в публичный JSON.

## Зависимости

### Внешние системы

- **GitHub API**: Чтение/запись JSON файла
- **Make.com**: Генерация JSON, обновление при бронировании
- **Google Calendar**: Источник базовых слотов, синхронизация

### Внутренние зависимости

- **Файлы**: `app.js` (логика загрузки слотов), `data/slots.json` (новый)
- **Компоненты**: Функции работы с датами, календарь
- **Другие тикеты**: T-001 должен быть завершён (стабильный UI)

## Метрики успеха

### Как измерим успех фичи?

**Количественные метрики**:
- Время загрузки слотов: < 500ms (было ~2-3 сек)
- Снижение операций Make.com на 70%+
- Ноль double-booking инцидентов

**Качественные метрики**:
- Пользователи не замечают изменений (работает как раньше, только быстрее)

## Риски и ограничения

### Технические риски

- **Риск 1**: Race condition при параллельных бронированиях
  - **Вероятность**: Средняя
  - **Влияние**: Высокое (double-booking)
  - **Митигация**: Атомарные операции в Make.com, проверка перед коммитом

- **Риск 2**: Рассинхронизация Git и Google Calendar
  - **Вероятность**: Низкая
  - **Влияние**: Среднее
  - **Митигация**: Периодическая полная синхронизация (раз в час)

- **Риск 3**: Размер JSON растёт со временем
  - **Вероятность**: Высокая
  - **Влияние**: Низкое
  - **Митигация**: Хранить только ближайшие 30 дней, архивировать старые

### Ограничения

- GitHub API rate limit: 60 req/hour (без токена), 5000 req/hour (с токеном)
- Make.com всё ещё нужен для записи (нет прямого доступа к Git из браузера)
- JSON должен быть публичным (или использовать токен)

## Открытые вопросы

Все вопросы закрыты.

## Решения и уточнения

### 2026-02-02 — Выбор способа доставки JSON
**Решение**: GitHub raw URL
Файл будет доступен по адресу: `https://raw.githubusercontent.com/{user}/{repo}/main/data/slots.json`

### 2026-02-02 — Структура JSON
**Решение**: Один общий файл `slots.json` для всех услуг
Проще в поддержке, размер контролируем через ограничение глубины (30 дней)

### 2026-02-02 — Авторизация записи в Git
**Решение**: Personal Access Token (PAT) в Make.com
- Токен создаётся в GitHub (Settings → Developer settings → Tokens)
- Права: `repo` (запись в репозиторий)
- Хранится только в Make.com, не попадает в код
- Claude/фронтенд токен НЕ использует — только Make.com для коммитов

### 2026-02-02 — Источник слотов и обновление JSON
**Решение**: Event-driven подход
- **Источник слотов**: Google Sheets (уже заполнено до марта, автогенерация)
- **Первичная сборка JSON**: вручную в Make.com (из Google Sheets)
- **Обновление JSON**:
  - Бронирование → Make.com помечает слот `status: "book"`
  - Отмена → Make.com помечает слот `status: "free"`
- **Автоматизация генерации из Sheets**: позже (Could Have)

### 2026-02-02 — Финальная структура JSON
**Решение**: Минимальная структура — только 5 полей
- `id` — идентификатор слота для бронирования
- `date` — дата (YYYY-MM-DD)
- `time` — время начала (HH:MM)
- `service` — тип услуги
- `status` — `free` / `book`

Персональные данные (client_name, telegram_id, zoom_link) НЕ включаются — остаются в Google Sheets.

## История изменений

Дата: 2026-02-02
Версия: DRAFT
Изменения: Первоначальная версия PRD

Дата: 2026-02-02
Версия: DRAFT v2
Изменения: Закрыты вопросы: GitHub raw, один JSON, PAT для Make.com

Дата: 2026-02-02
Версия: PRD_READY
Изменения: Закрыт вопрос обновления JSON (event-driven: бронь/отмена), источник слотов — Google Sheets

Дата: 2026-02-02
Версия: PRD_READY v2
Изменения: Финальная структура JSON — минимум полей (id, date, time, service, status), статусы free/book

## Чек-лист готовности PRD

Перед переходом к этапу планирования убедись:

- [x] Понятна проблема и цель фичи
- [x] Описаны все must-have требования
- [x] Расписан happy path и основные edge cases
- [x] Определены метрики успеха
- [x] Выявлены риски и зависимости
- [x] Все блокирующие вопросы закрыты
- [x] Статус изменён на `PRD_READY`

**Только после этого можно переходить к созданию плана!**
