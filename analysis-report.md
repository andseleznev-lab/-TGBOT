# Отчёт об анализе Telegram Mini App

## Дата анализа
31 января 2026

## Обнаруженные ошибки

### Критические (блокируют работу приложения)

#### 1. **[app.js:4]** - Отсутствует файл api.js
- **Тип**: Отсутствующий модуль
- **Причина**: `app.js` импортирует `import * as API from './api.js'`, но файла `api.js` не существует в проекте
- **Симптом в логах**: `"config": false` - приложение не может инициализироваться полностью
- **Решение**: Создать файл `api.js` с необходимыми функциями API

#### 2. **[index.html:324]** - Неверный тип скрипта для ES modules
- **Тип**: Ошибка загрузки модуля
- **Причина**: `app.js` использует ES modules (`import/export`), но загружается без `type="module"`
- **Код проблемы**:
  ```html
  <script src="app.js?v=3"></script>
  ```
- **Решение**: Добавить `type="module"`:
  ```html
  <script type="module" src="app.js?v=3"></script>
  ```

#### 3. **[config.js]** - CONFIG не экспортируется для ES modules
- **Тип**: Ошибка экспорта
- **Причина**: `config.js` объявляет `const CONFIG`, но не экспортирует его для использования в ES modules
- **Решение**: Добавить `export { CONFIG }` или использовать `export const CONFIG`

#### 4. **[index.html:92]** - Несоответствие data-tab атрибутов
- **Тип**: Логическая ошибка
- **Причина**: В HTML `data-tab="mybookings"`, а в JS проверяется `'my-bookings'`
- **Код проблемы**:
  ```html
  <button class="tab-btn" data-tab="mybookings">
  ```
- **Решение**: Изменить на `data-tab="my-bookings"`

#### 5. **[app.js:40-46]** - Неверные CSS-селекторы для вкладок
- **Тип**: Логическая ошибка
- **Причина**: JS ищет `.tab` и `.tab-content`, но в HTML используются `.tab-btn` и вкладки не имеют контента
- **Код проблемы**:
  ```javascript
  document.querySelectorAll('.tab').forEach(tab => {...})
  document.querySelectorAll('.tab-content').forEach(content => {...})
  ```
- **Решение**: Исправить селекторы на `.tab-btn` и добавить контейнеры `.tab-content`

#### 6. **[index.html]** - Отсутствует HTML-контент для вкладок
- **Тип**: Отсутствующий контент
- **Причина**: В HTML нет секций для вкладок Services, Payment, Booking, My Bookings
- **Решение**: Добавить соответствующие секции с ID

### Важные (ухудшают UX, но не блокируют)

#### 7. **Таймауты API запросов**
- **Тип**: Производительность
- **Причина**: В логах видны таймауты до 30 секунд
- **Симптомы**:
  - `⏱️ [get_user_bookings] ОТМЕНЁН или ТАЙМАУТ после 30015ms`
  - `⏱️ [get_available_dates] ОТМЕНЁН или ТАЙМАУТ после 30019ms`
- **Решение**: Добавить таймаут 10 секунд с retry логикой

#### 8. **[app.js:363]** - Накопление обработчиков MainButton.onClick
- **Тип**: Утечка памяти
- **Причина**: `MainButton.onClick(handleBooking)` добавляется при каждом выборе слота без удаления предыдущего
- **Решение**: Использовать `MainButton.offClick()` перед добавлением нового обработчика

### Некритические (улучшения кода)

#### 9. **[config.js:63-67]** - Заглушки для URL оплаты
- **Тип**: Неполная реализация
- **Причина**: PAYMENT_URLS содержат placeholder ссылки
- **Код**:
  ```javascript
  PAYMENT_URLS: {
      card: 'https://your-payment-link.com/card',
      ...
  }
  ```

## Проблемы безопасности

- **initData** - не проверяется на стороне сервера (должна быть валидация подписи в Make.com)
- **XSS** - `innerHTML` используется с данными из API (booking.zoom_link) - нужна санитизация

## Проблемы производительности

- Множественные запросы при быстром переключении вкладок (частично решено через AbortController)
- Отсутствие кэширования дат - при каждом переходе на вкладку Booking происходит запрос

## Проблемы интеграции с Telegram

- WebApp API используется корректно
- MainButton/BackButton - накопление обработчиков
- Темы - применяются, но не используются CSS-переменные Telegram

## Проблемы интеграции с Make.com

- Webhook URL - публично виден в config.js (должен быть на сервере)
- Формат данных - используется нестандартная структура с числовыми ключами ('0', '1', '2')

## План исправлений

1. Создать файл `api.js` с функциями API
2. Исправить загрузку ES modules в `index.html`
3. Добавить export в `config.js`
4. Исправить несоответствие data-tab атрибутов
5. Добавить HTML-контент для вкладок
6. Исправить CSS-селекторы в `app.js`
